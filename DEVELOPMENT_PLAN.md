# План разработки TAMS (Tokyo Anomaly Monitoring System)

## Обзор проекта

SPA на Next.js (App Router) для мониторинга духов (ёкаев) в реальном времени.

---

## Фаза 1: Инициализация проекта

### 1.1 Создание Next.js проекта с базовой конфигурацией ✅

- ✅ Инициализация Next.js с App Router
- ✅ Настройка TypeScript
- ✅ Установка зависимостей: TanStack Query, Zod
- ✅ Настройка SCSS Modules
- ✅ Базовая структура папок (начальный FSD скелет)

### 1.2 Docker-конфигурация ✅

- ✅ Создание `Dockerfile`
- ✅ Создание `docker-compose.yml`
- ✅ Настройка `output: 'standalone'` в next.config.mjs
- ✅ Создание `.dockerignore`
- Проверка запуска проекта через `docker-compose up`

---

## Фаза 2: Архитектура FSD (Feature Sliced Design)

### 2.1 Настройка слоёв FSD ✅

- ✅ Создание структуры папок:
  - `src/app` — App Router страницы
  - `src/pages` — (не используем, App Router)
  - `src/widgets` — композитные блоки
  - `src/features` — бизнес-фичи
  - `src/entities` — бизнес-сущности
  - `src/shared` — переиспользуемый код
- ✅ Настройка алиасов путей в `tsconfig.json`

---

## Фаза 3: Shared слой (базовые компоненты и утилиты)

### 3.1 Shared UI компоненты ✅

- ✅ Button (с вариантами: primary, danger)
- ✅ Card (контейнер для карточки)
- ✅ Badge (для статуса и уровня угрозы)
- ✅ Notification/Toast компонент

### 3.2 Shared API и типы ✅

- ✅ Базовая настройка API клиента (fetch обёртка)
- ✅ Общие типы (`ThreatLevel`, `AnomalyStatus`)
- ✅ Zod-схемы для валидации данных

### 3.3 Shared стили ✅

- ✅ CSS-переменные (цвета, отступы, типографика)
- ✅ Глобальные стили
- ✅ SCSS миксины (если нужны)

---

## Фаза 4: Entities слой

### 4.1 Entity: Anomaly (Дух/Аномалия)

- Типы и интерфейсы (`Anomaly`)
- Zod-схема валидации
- UI компонент `AnomalyCard` (отображение одного духа)
- Цветовая индикация уровня угрозы

---

## Фаза 5: Backend (API Routes)

### 5.1 Mock API — список аномалий

- Route Handler: `GET /api/anomalies`
- Моковые данные (5-10 духов с разными параметрами)
- Валидация ответа через Zod

### 5.2 Mock API — захват духа

- Route Handler: `POST /api/anomalies/[id]/capture`
- Логика 30% вероятности ошибки
- Корректные HTTP статусы (200/500)

### 5.3 SSE Endpoint для real-time обновлений

- Route Handler: `GET /api/anomalies/stream` (SSE)
- Логика: каждые 5 сек случайный дух меняет threat level
- Формат события для клиента

---

## Фаза 6: Features слой

### 6.1 Feature: Capture Anomaly (Захват духа)

- Хук `useCaptureAnomaly` (TanStack Query mutation)
- Optimistic Update логика
- Rollback при ошибке
- Интеграция с Notification

### 6.2 Feature: Real-time Updates (SSE подписка)

- Хук `useAnomalyStream` (подписка на SSE)
- Обновление кэша TanStack Query при получении события
- Автопереподключение при разрыве

---

## Фаза 7: Widgets слой

### 7.1 Widget: AnomalyList

- Компонент списка аномалий
- Интеграция с `useQuery` для получения данных
- Компоновка карточек
- Состояния: loading, error, empty

### 7.2 Widget: NotificationContainer

- Контейнер для показа уведомлений
- Логика автоскрытия
- Стили для success/error

---

## Фаза 8: App слой (страницы)

### 8.1 Страница /monitoring

- Layout с провайдерами (QueryClientProvider)
- Композиция виджетов на странице
- Подключение SSE стрима
- Базовый UI страницы (заголовок, layout)

### 8.2 Глобальные провайдеры

- QueryClientProvider настройка
- Notification провайдер (если используем контекст)

---

## Фаза 9: Финализация

### 9.1 Тестирование и отладка

- Проверка всех сценариев:
  - Загрузка списка
  - Успешный захват
  - Неуспешный захват (rollback)
  - Real-time обновления
- Проверка Docker-сборки

### 9.2 Код-ревью и рефакторинг

- Проверка соответствия FSD
- Чистка кода
- Проверка TypeScript строгости
- README.md с инструкцией запуска

---

## Порядок выполнения (рекомендуемый)

```
1.1 → 1.2 → 2.1 → 3.3 → 3.2 → 3.1 → 4.1 → 5.1 → 5.2 → 5.3 → 6.1 → 6.2 → 7.1 → 7.2 → 8.2 → 8.1 → 9.1 → 9.2
```

---

## Оценка по задачам

| Задача | Сложность | Примерный объём       |
| ------ | --------- | --------------------- |
| 1.1    | Низкая    | Конфиги + npm         |
| 1.2    | Низкая    | 2 файла               |
| 2.1    | Низкая    | Структура папок       |
| 3.1    | Средняя   | 4 компонента          |
| 3.2    | Низкая    | Типы + схемы          |
| 3.3    | Низкая    | CSS переменные        |
| 4.1    | Средняя   | Entity + UI           |
| 5.1    | Низкая    | 1 route handler       |
| 5.2    | Низкая    | 1 route handler       |
| 5.3    | Средняя   | SSE логика            |
| 6.1    | Средняя   | Mutation + optimistic |
| 6.2    | Средняя   | SSE hook              |
| 7.1    | Средняя   | Композиция            |
| 7.2    | Низкая    | Toast система         |
| 8.1    | Средняя   | Сборка страницы       |
| 8.2    | Низкая    | Провайдеры            |
| 9.1    | Низкая    | Тестирование          |
| 9.2    | Низкая    | Документация          |

---

## Примечания

1. **Каждая задача = одна итерация** — задачи декомпозированы так, чтобы укладываться в лимиты контекста.

2. **Зависимости**: Задачи внутри фазы можно делать параллельно (где нет зависимостей). Фазы идут последовательно.

3. **FSD строгость**: Импорты только сверху вниз (app → widgets → features → entities → shared).

4. **Нет Tailwind** — только SCSS Modules, это важное ограничение из ТЗ.
